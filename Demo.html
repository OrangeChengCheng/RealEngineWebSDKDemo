<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=0" />
    <title>RealEngineWebSDKDemo</title>
    <link rel="stylesheet" href="https://demo.bjblackhole.com/BlackHole3.0/css/style.css">
</head>

<body>
    <div id="canvas-cntr">
        <canvas id="canvas" style="width:100%; height:100%;" oncontextmenu="event.preventDefault()"
            tabindex="1"></canvas>
        <div class="custom-loading-container">
            <div class="loading-box">
                <div class="icon-box">
                    <img src="https://demo.bjblackhole.com/BlackHole3.0/imgs/loading.gif" />
                </div>
                <div class="common-global-progress-box">
                    <div class="custom-progress-box">
                        <div class="progress-bar">
                            <div class="progress-bar-outer">
                                <div class="progress-bar-inner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="custom-text"></div>
                </div>
                <div class="process-info-box"></div>
            </div>
        </div>
        <div class="btn">
            <button onclick="addOneEntity()">添加实例A</button>
            <button onclick="addTwoEntity()">添加实例B</button>
            <button onclick="startAnim()">开启动画</button>
            <button onclick="stopAnim()">暂停动画</button>
        </div>
    </div>
    <script async type="text/javascript" src="javascript/RealBIMWeb.js"></script>
    <script async type="text/javascript" src="javascript/BlackHole3D.js"></script>
    <!-- <script async type="text/javascript" src="https://demo.bjblackhole.com/BlackHole3.0/sdk/RealBIMWeb.js"></script>
    <script async type="text/javascript" src="https://demo.bjblackhole.com/BlackHole3.0/sdk/BlackHole3D.js"></script> -->
    <!-- 引擎初始化相关接口 -->
    <script type="text/javascript">
        BlackHole3D = typeof BlackHole3D !== "undefined" ? BlackHole3D : {};
        BlackHole3D["canvas"] = (function () {
            var canvas = document.getElementById('canvas');
            return canvas;
        })();
        window.onresize = function (event) {
            BlackHole3D["m_re_em_window_width"] = BlackHole3D.canvas.clientWidth;
            BlackHole3D["m_re_em_window_height"] = BlackHole3D.canvas.clientHeight;
        }
        window.onbeforeunload = function (event) {
            if (typeof BlackHole3D.releaseEngine != 'undefined') {
                BlackHole3D.releaseEngine();
            }
        };
        window.onload = function (event) {
            if (typeof CreateBlackHoleWebSDK != 'undefined') {
                BlackHole3D = CreateBlackHoleWebSDK(BlackHole3D);
            } else {
                document.addEventListener("RealEngineToBeReady", function () { BlackHole3D = CreateBlackHoleWebSDK(BlackHole3D); });
            }
            document.addEventListener("RESystemReady", RESystemReady);//系统初始化监听
            document.addEventListener("RESystemEngineCreated", RESystemEngineCreated);//场景初始化监听
            document.addEventListener("REDataSetLoadProgress", REDataSetLoadProgress);//模型加载进度监听
            document.addEventListener("REDataSetLoadFinish", REDataSetLoadFinish);//模型加载完成状态
            document.addEventListener("REExitEntityEditMode", REExitEntityEditMode);//单构件鼠标添加模式添加实例结束回调事件
            if ((typeof BlackHole3D["m_re_em_window_width"] != 'undefined') && (typeof BlackHole3D["m_re_em_window_height"] != 'undefined') && (typeof BlackHole3D.RealBIMWeb != 'undefined')) {
                console.log("(typeof m_re_em_window_width != 'undefined') && (typeof m_re_em_window_height != 'undefined')");
                RESystemReady();
            }
        }
        function RESystemReady() {
            var sysInfo = new BlackHole3D.RESysInfo();
            sysInfo.workerjsPath = "https://demo.bjblackhole.com/BlackHole3.0/sdk/RealBIMWeb_Worker.js";
            sysInfo.renderWidth = BlackHole3D.canvas.clientWidth;
            sysInfo.renderHieght = BlackHole3D.canvas.clientHeight;
            sysInfo.commonUrl = "https://demo.bjblackhole.com/default.aspx?dir=url_res02&path=res_gol001";
            sysInfo.userName = "";
            sysInfo.passWord = "";
            BlackHole3D.initEngineSys(sysInfo);
            BlackHole3D.Common.setUseWebCache(true);//是否允许使用浏览器缓存
        }
        //初始化完成后，加载项目
        function RESystemEngineCreated(e) {
            console.log("当前 WebSDK 运行版本", BlackHole3D.getVersion());
            console.log("=========================== 场景初始化完成");
            var isSuccess = e.detail.succeed;
            if (isSuccess) {
                console.log("===========================  场景初始化 --> 成功！！！");
                var dataSetList = [{
                    "dataSetId": "单构件模版",
                    "resourcesAddress": "https://demo.bjblackhole.com/default.aspx?dir=url_res02&path=res_entity_anim_test02",
                    "useTransInfo": true, "transInfo": [[1, 1, 1], [0, 0, 0, 1], [0.0, 0.0, 0.0]],
                    "dataSetCRS": "", "dataSetCRSNorth": 0.0
                }];
                BlackHole3D.Model.loadDataSet(dataSetList);

                BlackHole3D.Common.setMaxResMemMB(5500);
                BlackHole3D.Common.setExpectMaxInstMemMB(4500);
                BlackHole3D.Common.setExpectMaxInstDrawFaceNum(20000000);
                BlackHole3D.Common.setPageLoadLev(2);
            } else {
                console.log("===========================  场景初始化 --> 失败！！！");
            }
        }
        function REDataSetLoadProgress(e) {
            var progBoxCntr = document.querySelector(".custom-loading-container");
            var progBox = document.querySelector(".progress-bar-inner");
            var progTxt = document.querySelector(".custom-text");
            var progInfo = document.querySelector(".process-info-box");
            var percent = e.detail.progress;
            var processInfo = e.detail.info;
            if (percent < 100) {
                progBox.style.width = `${percent}%`
                progBoxCntr.style.display = "flex";
                progTxt.innerHTML = `${percent}%`
                progInfo.innerHTML = processInfo
            } else {
                progBoxCntr.style.display = "none";
            }
        }
        //模型加载完成状态
        function REDataSetLoadFinish(e) {
            if (e.detail.succeed) {
                //模型加载完成！！！
                document.getElementById('canvas').style.display = "block";
                BlackHole3D.canvas.focus(); //为了解决键盘事件的冲突
            } else {
                //模型加载失败！！！
            }
        }
        //单构件鼠标添加模式添加实例结束回调事件
        function REExitEntityEditMode(e) {
            alert("实例添加结束");
        }
        //添加实例A
        function addOneEntity() {
            BlackHole3D.Entity.enterEditMode();//进入编辑模式
            let typeNames = BlackHole3D.Entity.getAllTypeNames("单构件模版");//获取所有的实例类型名称
            if (typeNames.length) {
                let entityList = [];
                let entity = new BlackHole3D.REEntityInfo();//创建实例信息对象
                entity.dataSetId = "单构件模版";
                entity.entityType = typeNames[0];
                entity.elemId = 1;//自定义构件id，不可重复，重复添加失败
                entity.scale = [1.0, 1.0, 1.0];// 缩放
                entity.rotate = [0.0, 0.0, 0.0, 1.0];// 旋转
                entity.offset = [0.0, 0.0, 0.0];// 平移
                entity.dataSetCRS = "";// 坐标系标识
                entityList.push(entity);
                let add = BlackHole3D.Entity.addEntities(entityList);//添加实例对象
                add ? alert("实例添加成功") : alert("实例添加失败");
            }
            BlackHole3D.Entity.exitEditMode();//结束编辑模式
        }
        //添加实例B
        function addTwoEntity() {
            BlackHole3D.Entity.enterEditMode();//进入编辑模式
            let typeNames = BlackHole3D.Entity.getAllTypeNames("单构件模版");//获取所有的实例类型名称
            if (typeNames.length) {
                let entityList = [];
                let entity = new BlackHole3D.REEntityInfo();//创建实例信息对象
                entity.dataSetId = "单构件模版";
                entity.entityType = typeNames[0];
                entity.elemId = 2;//自定义构件id，不可重复，重复添加失败
                entity.scale = [1.0, 1.0, 1.0];// 缩放
                entity.rotate = [0.0, 0.0, 0.0, 1.0];// 旋转
                entity.offset = [10.0, 10.0, 0.0];// 平移
                entity.dataSetCRS = "";// 坐标系标识
                entityList.push(entity);
                let add = BlackHole3D.Entity.addEntities(entityList);//添加实例对象
                add ? alert("实例添加成功") : alert("实例添加失败");
            }
            BlackHole3D.Entity.exitEditMode();//结束编辑模式
        }
        //开启动画
        function startAnim() {
            let typeNames = BlackHole3D.Entity.getAllTypeNames("单构件模版");//获取所有的实例类型名称
            let animPlayInfo = new BlackHole3D.REEntityAnimPlayInfo();//创建实例动画信息
            animPlayInfo.dataSetId = "单构件模版";
            animPlayInfo.entityType = typeNames[0];
            animPlayInfo.elemIdList = [];
            animPlayInfo.animPlayMode = BlackHole3D.REEntityAnimPlayModeEm.REPEATTURN;//动画的播放模式
            animPlayInfo.animPlayState = BlackHole3D.REEntityAnimPlayStateEm.PLAY;//动画的播放状态
            BlackHole3D.Entity.setAnimPlayMode(animPlayInfo);//设置实体动画的播放信息
        }
        //暂停动画
        function stopAnim() {
            let typeNames = BlackHole3D.Entity.getAllTypeNames("单构件模版");//获取所有的实例类型名称
            let animPlayInfo = new BlackHole3D.REEntityAnimPlayInfo();//创建实例动画信息
            animPlayInfo.dataSetId = "单构件模版";
            animPlayInfo.entityType = typeNames[0];
            animPlayInfo.elemIdList = [];
            animPlayInfo.animPlayMode = BlackHole3D.REEntityAnimPlayModeEm.REPEATTURN;//动画的播放模式
            animPlayInfo.animPlayState = BlackHole3D.REEntityAnimPlayStateEm.PAUSE;//动画的播放状态
            BlackHole3D.Entity.setAnimPlayMode(animPlayInfo);//设置实体动画的播放信息
        }
    </script>
</body>

</html>